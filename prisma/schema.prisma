generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String                         @id @default(cuid())
  email                         String                         @unique
  name                          String?
  password                      String?
  image                         String?
  lastfmUsername                String                         @unique
  lastfmSessionKey              String?
  isSuperuser                   Boolean                        @default(false)
  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime                       @updatedAt
  quickAccessGroupId            String?
  emailVerificationToken        String?
  emailVerificationTokenExpires DateTime?
  emailVerified                 Boolean                        @default(false)
  lastVerificationEmailSentAt   DateTime?
  lastPasswordResetEmailSentAt  DateTime?
  passwordResetToken            String?
  passwordResetTokenExpires     DateTime?
  locale                        String?
  chartEntryStatsAsMajorDriver  ChartEntryStats[]
  friendshipsAsFriend           Friendship[]                   @relation("FriendFriendships")
  friendshipsAsUser             Friendship[]                   @relation("UserFriendships")
  comments                      GroupComment[]
  groupCompatibilityScores      GroupCompatibilityScore[]
  groupInvites                  GroupInvite[]
  groupJoinRequests             GroupJoinRequest[]
  groupMemberships              GroupMember[]
  recommendationCache           GroupRecommendationCache?
  groupRecommendationRejections GroupRecommendationRejection[]
  shoutboxPermissionsGranted    GroupShoutboxPermission[]      @relation("ShoutboxPermissionsGranted")
  shoutboxPermissions           GroupShoutboxPermission[]
  groupsCreated                 Group[]                        @relation("GroupCreator")
  listeningStats                ListeningStat[]
  chartEntryVS                  UserChartEntryVS[]
  commentBansIssued             UserCommentBan[]               @relation("CommentBansIssued")
  commentBans                   UserCommentBan?                @relation("UserCommentBans")
  weeklyStats                   UserWeeklyStats[]
  quickAccessGroup              Group?                         @relation("QuickAccessGroup", fields: [quickAccessGroupId], references: [id])

  @@map("users")
}

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  friendId  String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  friend    User     @relation("FriendFriendships", fields: [friendId], references: [id], onDelete: Cascade)
  user      User     @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friendships")
}

model ListeningStat {
  id         String    @id @default(cuid())
  userId     String
  trackName  String
  artistName String
  albumName  String?
  playCount  Int       @default(1)
  lastPlayed DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([trackName, artistName])
  @@map("listening_stats")
}

model Group {
  id                        String                         @id @default(cuid())
  name                      String
  image                     String?
  creatorId                 String?
  isPrivate                 Boolean                        @default(false)
  allowFreeJoin             Boolean                        @default(false)
  chartSize                 Int                            @default(10)
  chartMode                 String                         @default("vs")
  trackingDayOfWeek         Int                            @default(0)
  dynamicIconEnabled        Boolean                        @default(false)
  dynamicIconSource         String?
  colorTheme                String?                        @default("white")
  createdAt                 DateTime                       @default(now())
  updatedAt                 DateTime                       @updatedAt
  chartGenerationInProgress Boolean                        @default(false)
  chartGenerationStartedAt  DateTime?
  chartGenerationProgress   Json?
  lastChartGenerationFailedUsers Json?
  lastChartGenerationAborted Boolean?
  dynamicIconCaption        String?
  shoutboxEnabled           Boolean                        @default(true)
  shoutboxRestrictiveMode   Boolean                        @default(false)
  chartEntryStats           ChartEntryStats[]
  allTimeStats              GroupAllTimeStats?
  chartEntries              GroupChartEntry[]
  comments                  GroupComment[]
  compatibilityScores       GroupCompatibilityScore[]
  invites                   GroupInvite[]
  joinRequests              GroupJoinRequest[]
  members                   GroupMember[]
  recommendationRejections  GroupRecommendationRejection[]
  records                   GroupRecords?
  shoutboxPermissions       GroupShoutboxPermission[]
  trends                    GroupTrends?
  weeklyStats               GroupWeeklyStats[]
  creator                   User?                          @relation("GroupCreator", fields: [creatorId], references: [id])
  quickAccessUsers          User[]                         @relation("QuickAccessGroup")

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(cuid())
  groupId  String
  userId   String
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model UserWeeklyStats {
  id         String   @id @default(cuid())
  userId     String
  weekStart  DateTime
  weekEnd    DateTime
  topArtists Json
  topTracks  Json
  topAlbums  Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId, weekStart])
  @@map("user_weekly_stats")
}

model GroupWeeklyStats {
  id         String   @id @default(cuid())
  groupId    String
  weekStart  DateTime
  weekEnd    DateTime
  topArtists Json
  topTracks  Json
  topAlbums  Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  group      Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, weekStart])
  @@index([groupId, weekStart])
  @@map("group_weekly_stats")
}

model GroupChartEntry {
  id                 String   @id @default(cuid())
  groupId            String
  weekStart          DateTime
  chartType          String
  entryKey           String
  name               String
  artist             String?
  position           Int
  playcount          Int
  vibeScore          Float?
  positionChange     Int?
  playsChange        Int?
  totalWeeksAppeared Int
  highestPosition    Int
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  entryType          String?
  slug               String?
  group              Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, weekStart, chartType, entryKey])
  @@index([groupId, weekStart, chartType])
  @@index([groupId, chartType, entryKey])
  @@index([groupId, chartType, slug])
  @@map("group_chart_entries")
}

model GroupAllTimeStats {
  id          String   @id @default(cuid())
  groupId     String   @unique
  topArtists  Json
  topTracks   Json
  topAlbums   Json
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_all_time_stats")
}

model GroupJoinRequest {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId, status])
  @@map("group_join_requests")
}

model GroupInvite {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId, status])
  @@index([userId, status])
  @@map("group_invites")
}

model UserChartEntryVS {
  id        String   @id @default(cuid())
  userId    String?
  weekStart DateTime
  chartType String
  entryKey  String
  vibeScore Float
  playcount Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([userId, weekStart, chartType, entryKey])
  @@index([userId, weekStart])
  @@index([userId, weekStart, chartType])
  @@map("user_chart_entry_vs")
}

model GroupCompatibilityScore {
  id             String   @id @default(cuid())
  userId         String
  groupId        String
  score          Float
  artistOverlap  Float
  trackOverlap   Float
  genreOverlap   Float
  patternScore   Float
  lastCalculated DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  group          Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId, score])
  @@index([groupId])
  @@map("group_compatibility_scores")
}

model GroupRecommendationRejection {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now())
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@map("group_recommendation_rejections")
}

model ArtistGenre {
  id          String   @id @default(cuid())
  artistName  String   @unique
  genres      Json
  lastFetched DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([artistName])
  @@map("artist_genres")
}

model GroupRecommendationCache {
  id              String   @id @default(cuid())
  userId          String   @unique
  recommendations Json
  lastCalculated  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("group_recommendation_cache")
}

model GroupTrends {
  id                String    @id @default(cuid())
  groupId           String    @unique
  weekStart         DateTime
  weekEnd           DateTime
  newEntries        Json
  biggestClimbers   Json
  biggestFallers    Json
  exits             Json
  topContributors   Json?
  memberSpotlight   Json?
  totalPlays        Int
  totalPlaysChange  Int?
  chartTurnover     Int
  funFacts          Json
  previousWeekStart DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  group             Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_trends")
}

model ChartEntryStats {
  id                     String    @id @default(cuid())
  groupId                String
  chartType              String
  entryKey               String
  slug                   String
  peakPosition           Int
  weeksAtPeak            Int
  weeksAtOne             Int                @default(0)
  debutPosition          Int
  weeksInTop10           Int
  totalWeeksCharting     Int
  longestStreak          Int
  isStreakOngoing        Boolean
  majorDriverUserId      String?
  majorDriverName        String?
  majorDriverVS          Float?
  majorDriverPlays       Int?
  majorDriverLastUpdated DateTime?
  totalVS                Float?
  totalPlays             Int
  statsStale             Boolean   @default(false)
  statsLastUpdated       DateTime?
  latestAppearance       DateTime?
  lastUpdated            DateTime  @default(now())
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  group                  Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  majorDriver            User?     @relation(fields: [majorDriverUserId], references: [id])

  @@unique([groupId, chartType, entryKey])
  @@index([groupId, chartType, slug])
  @@index([groupId, chartType, entryKey])
  @@map("chart_entry_stats")
}

model GroupComment {
  id        String   @id @default(cuid())
  groupId   String
  userId    String?
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([groupId, createdAt])
  @@index([userId, createdAt])
  @@map("group_comments")
}

model UserCommentBan {
  id           String   @id @default(cuid())
  userId       String   @unique
  bannedBy     String
  reason       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  bannedByUser User     @relation("CommentBansIssued", fields: [bannedBy], references: [id], onDelete: Cascade)
  user         User     @relation("UserCommentBans", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_comment_bans")
}

model GroupShoutboxPermission {
  id            String   @id @default(cuid())
  groupId       String
  userId        String
  permission    String
  grantedBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  grantedByUser User     @relation("ShoutboxPermissionsGranted", fields: [grantedBy], references: [id], onDelete: Cascade)
  group         Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId, permission])
  @@index([userId])
  @@map("group_shoutbox_permissions")
}

model GroupRecords {
  id                   String    @id @default(cuid())
  groupId              String    @unique
  status               String
  calculationStartedAt DateTime?
  chartsGeneratedAt    DateTime?
  records              Json
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  group                Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("group_records")
}
